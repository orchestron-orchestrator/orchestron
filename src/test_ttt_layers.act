import testing
import logging

import orchestron.ttt as ttt
#import orchestron.gdata as gdata
import yang.gdata as gdata

TEST_NS = "urn:test"

def q(n: str) -> gdata.Id:
    return gdata.Id(TEST_NS, n)


cfg1 = gdata.List([q("name")], [
    gdata.Container({
        q("name"): gdata.Leaf("k1"),
        q("n1"): gdata.Leaf(bigint(1)),
        q("n2"): gdata.Leaf(bigint(2))
    }),
    gdata.Container({
        q("name"): gdata.Leaf("k2"),
        q("n1"): gdata.Leaf(bigint(4))
    })
])

cfg2 = gdata.List([q("name")], [
    gdata.Container({
        q("name"): gdata.Leaf("k1"),
        q("n2"): gdata.Leaf(bigint(2)),
        q("n3"): gdata.Leaf(bigint(3))
    }),
    gdata.Container({
        q("name"): gdata.Leaf("k3"),
        q("n1"): gdata.Leaf(bigint(1)),
        q("n3"): gdata.Leaf(bigint(3))
    })
])

out1 = gdata.Container({
    q('devices'): gdata.List([q("id")], [
        gdata.Container({
            q("id"): gdata.Leaf("k1"),
            q("n1"): gdata.Leaf(bigint(1)),
            q("n2"): gdata.Leaf(bigint(2))
        }),
        gdata.Container({
            q("id"): gdata.Leaf("k2"),
            q("n1"): gdata.Leaf(bigint(4))
        })
    ])
})

out1_2 = gdata.Container({
    q('devices'): gdata.List([q("id")], [
        gdata.Container({
            q("id"): gdata.Leaf("k1"),
            q("n1"): gdata.Leaf(bigint(1)),
            q("n2"): gdata.Leaf(bigint(2)),
            q("n3"): gdata.Leaf(bigint(3))
        }),
        gdata.Container({
            q("id"): gdata.Leaf("k3"),
            q("n1"): gdata.Leaf(bigint(1)),
            q("n3"): gdata.Leaf(bigint(3))
        }),
        gdata.Container({
            q("id"): gdata.Leaf("k2"),
            q("n1"): gdata.Leaf(bigint(4))
        })
    ])
})

class TransF(ttt.TransformFunction):
    def transform_wrapper(self, cfg, memory, dynstate):
        """Simple transform that copies inputs to ouputs (sans keys)

        The input list layer is keyed on "name", the output on "id". This
        transform copies all child elements to the next layer, while renaming
        the key.
        """
        if isinstance(cfg, gdata.Container):
            # Copy all child nodes
            out = gdata.Container(dict(cfg.children.items()))
            # "Rename" the key leaf
            out.children[q("id")] = gdata.Leaf(cfg.get_leaf(q("name")).val)
            del out.children[q("name")]
            return gdata.Container({
                q('devices'): gdata.List([q("id")], [
                    out
                ])
            }), None
        else:
            return gdata.Container({}), None


########################

actor basic_output(t: testing.AsyncT):
    out = ttt.Sink().newsession()
    tlist = ttt.List(ttt.Transform(TransF), [q("name")]) ([], None)
    t1 = tlist.newtrans()

    t1.configure("1", {'srcA': cfg1}, out)

    def cont1(res: value):
        t1.commit("1", True)
        t1.get()
        out.apply("1")
        out.lock("1", cont2)

    def cont2(res: value):
        out.commit("1", True)
        r = out.get()
        testing.assertEqual(r, out1)
        t.success()

    t1.lock("1", out, cont1)

actor layered_commit(t: testing.AsyncT):
    stack = ttt.Layer("top", ttt.List(ttt.Transform(TransF), [q("name")]), ttt.Sink())

    sess = stack.newsession()

    def cont1(_r: value):
        r0 = sess.get()
        testing.assertEqual(r0, cfg1)
        r1 = sess.below().get()
        testing.assertEqual(r1, out1)
        t.success()

    sess.edit_config(cfg1, cont1)

actor simultaneous_commit(t: testing.AsyncT):
    stack = ttt.Layer("top", ttt.List(ttt.Transform(TransF), [q("name")]), ttt.Sink())

    sess1 = stack.newsession()
    sess2 = stack.newsession()

    var acks = 0

    def cont(_r: value):
        acks += 1
        if acks == 2:
            r2 = sess2.below().get()
            r1 = sess1.below().get()
            testing.assertEqual(r1, out1_2)
            t.success()

    sess1.edit_config(cfg1, cont)
    sess2.edit_config(cfg2, cont)

########################

cfg3 = gdata.Container({
    q("left"): gdata.Container({
        q("a"): gdata.Leaf(bigint(1))
    }),
    q("right"): gdata.Container({
        q("a"): gdata.Leaf(bigint(2))
    })
})

out3 = gdata.Container({
    q('devices'): gdata.List([q("id")], [
        gdata.Container({
            q("id"): gdata.Leaf(bigint(1)),
            q("val"): gdata.Leaf(bigint(1))
        }),
        gdata.Container({
            q("id"): gdata.Leaf(bigint(2)),
            q("val"): gdata.Leaf(bigint(2))
        })
    ])
})

class WriteDev(ttt.TransformFunction):
    def transform_wrapper(self, cfg: gdata.Node, memory, dynstate):
        i = cfg.get_bigint(q("a"))
        return gdata.Container({
            q('devices'): gdata.List([q("id")], [
                gdata.Container({
                    q("id"): gdata.Leaf(i),
                    q("val"): gdata.Leaf(i)
                })
            ])
        }), None

actor diamond_commit(t: testing.AsyncT):
    stack = ttt.Layer("top",
        ttt.Container({
            q("left"): ttt.Transform(WriteDev),
            q("right"): ttt.Transform(WriteDev)
        }),
        ttt.Sink())

    sess = stack.newsession()

    def cont(_r: value):
        r = sess.below().get()
        testing.assertEqual(r, out3)
        t.success()

    sess.edit_config(cfg3, cont)

########################

cfg4 = gdata.Container({
    q("ll"): gdata.Leaf(bigint(1)),
    q("rr"): gdata.Leaf(bigint(2))
})

class ServiceMap(ttt.TransformFunction):
    def transform_wrapper(self, cfg, memory, dynstate):
        ll = cfg.get_bigint(q("ll"))
        rr = cfg.get_bigint(q("rr"))
        return gdata.Container({
            q("left"): gdata.Container({
                q("a"): gdata.Leaf(ll)
            }),
            q("right"): gdata.Container({
                q("a"): gdata.Leaf(rr)
            })
        }), None

actor multi_layer(t: testing.AsyncT):
    stack = ttt.Layer("top",
                ttt.Transform(ServiceMap),
                ttt.Layer("bottom",
                    ttt.Container({
                        q("left"): ttt.Transform(WriteDev),
                        q("right"): ttt.Transform(WriteDev)
                    }),
                    ttt.Sink()))

    sess = stack.newsession()

    def cont(_r: value):
        r1 = sess.below().get()
        testing.assertEqual(r1.prsrc(), cfg3.prsrc())
        r2 = sess.below().below().get()
        testing.assertEqual(r2, out3)
        t.success()

    sess.edit_config(cfg4, cont)

########################

cfg5 = gdata.Container({
    q("a"): gdata.Leaf(bigint(1)),
})

cfg6 = gdata.Container({
    q("a"): gdata.Leaf(bigint(2)),
})

out5 = gdata.Container({
    q("b"): gdata.Leaf(bigint(3)),
})


class WriteDevs(ttt.TransformFunction):
    def transform_wrapper(self, cfg: gdata.Node, memory, dynstate):
        return out5, None

actor _test_redundant_config(t: testing.AsyncT):
    stack = ttt.Layer("top",
        ttt.Transform(WriteDevs),
        ttt.Sink())

    sess = stack.newsession()

    def cont(_r: value):
        r = sess.below().get()
        testing.assertEqual(r, out5)
        sess2 = stack.newsession()
        sess2.edit_config(cfg6, cont2)

    def cont2(_r):
        r = sess.below().get()
        testing.assertEqual(r, out5)
        t.success()

    sess.edit_config(cfg5, cont)
