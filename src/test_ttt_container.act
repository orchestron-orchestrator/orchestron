import testing
import logging

import orchestron.ttt as ttt
#import orchestron.gdata as gdata
import yang.gdata as gdata

TEST_NS = "urn:test"

def q(n: str) -> gdata.Id:
    return gdata.Id(TEST_NS, n)


tree1 = gdata.Container({
    q('left'): gdata.Container({
        q("l1"): gdata.List([q("name")], [
            gdata.Container({
                q("name"): gdata.Leaf("k1"),
                q("n1"): gdata.Leaf(1),
                q("n2"): gdata.Leaf(2)
            }),
            gdata.Container({
                q("name"): gdata.Leaf("k4"),
                q("n4"): gdata.Leaf(4)
            })
        ])
    }),
    q('right'): gdata.Container({
        q("a"): gdata.LeafList([gdata.LeafListEntryMerge(1), gdata.LeafListEntryMerge(2) ,gdata.LeafListEntryMerge(3)])
    })
})

tree2 = gdata.Container({
    q('left'): gdata.Container({
        q("l1"): gdata.List([q("name")], [
            gdata.Container({
                q("name"): gdata.Leaf("k1"),
                q("n2"): gdata.Leaf(2)
            }),
            gdata.Container({
                q("name"): gdata.Leaf("k2"),
                q("n1"): gdata.Leaf(1),
                q("n3"): gdata.Leaf(3)
            })
        ]),
    }),
    q('right'): gdata.Container({
        q("b"): gdata.Leaf(1)
    })
})

merge_1_2 = gdata.Container({
    q('left'): gdata.Container({
        q("l1"): gdata.List([q("name")], [
            gdata.Container({
                q("name"): gdata.Leaf("k1"),
                q("n1"): gdata.Leaf(1),
                q("n2"): gdata.Leaf(2)
            }),
            gdata.Container({
                q("name"): gdata.Leaf("k2"),
                q("n1"): gdata.Leaf(1),
                q("n3"): gdata.Leaf(3)
            }),
            gdata.Container({
                q("name"): gdata.Leaf("k4"),
                q("n4"): gdata.Leaf(4)
            })
        ]),
    }),
    q('right'): gdata.Container({
        q("a"): gdata.LeafList([gdata.LeafListEntryMerge(1), gdata.LeafListEntryMerge(2) ,gdata.LeafListEntryMerge(3)]),
        q("b"): gdata.Leaf(1)
    })
})


########################

actor basic_commit(t: testing.AsyncT):
    container = ttt.Container({
        q('left'): ttt.Transform(ttt.PassThrough),
        q('right'): ttt.Transform(ttt.PassThrough)
    })([], None)
    t1 = container.newtrans()

    t1.configure("1", {'srcA': tree1}, None)

    def cont1(_r: value):
        t1.commit("1", True)
        r = t1.get()
        testing.assertEqual(r, tree1)
        t.success()

    t1.lock("1", None, cont1)


########################

actor all_delete(t: testing.AsyncT):
    in1 = gdata.Container({
            q("left") : gdata.Container({
                q("x"): gdata.Leaf(1)
            }),
            q("right"): gdata.Container({
                q("x"): gdata.Leaf(2)
            })
        })

    tlist = ttt.Container({
                q("left"): ttt.Transform(ttt.PassThrough),
                q("right"): ttt.Transform(ttt.PassThrough)
            }) ([], None)
    t1 = tlist.newtrans()
    t1.configure("1", {"srcA": in1})

    def cont1(r):
        t1.commit("1", True)
        out1 = t1.get()
        testing.assertEqual(out1, in1)
        t1.configure("1", {"srcA": gdata.Absent()})

        def cont2(r):
            if isinstance(r, str):
                testing.assertEqual(r, "Empty")
            t1.commit("1", True)
            out2 = t1.get()
            exp2 = gdata.Container({
                q("left"): gdata.Container(),
                q("right"): gdata.Container()
            })
            testing.assertEqual(out2, exp2)
            t.success()

        t1.lock("1", None, cont2)

    t1.lock("1", None, cont1)


########################

actor nested_delete(t: testing.AsyncT):
    in1 = gdata.Container({
        q("left"): gdata.List([q("name")], [
            gdata.Container({
                q("name"): gdata.Leaf("k1"),
                q("x"): gdata.Leaf(1)
            }),
            gdata.Container({
                q("name"): gdata.Leaf("k2"),
                q("x"): gdata.Leaf(2)
            })
        ]),
        q("right"): gdata.List([q("name")], [
            gdata.Container({
                q("name"): gdata.Leaf("v1"),
                q("y"): gdata.Leaf(1)
            }),
        ])
    })

    tlist = ttt.Container({
                q("left"): ttt.List(ttt.Transform(ttt.PassThrough), [q("name")]),
                q("right"): ttt.List(ttt.Transform(ttt.PassThrough), [q("name")])
            }) ([], None)
    t1 = tlist.newtrans()
    t1.configure("1", {"srcA": in1})

    def cont1(r):
        t1.commit("1", True)
        out1 = t1.get()
        testing.assertEqual(out1, in1)
        t1.configure("1", {"srcA": gdata.Absent()})

        def cont2(r):
            if isinstance(r, str):
                testing.assertEqual(r, "Empty")
            t1.commit("1", True)
            out2 = t1.get()
            exp2 = gdata.Container({
                q("left"): gdata.List([q("name")], []),
                q("right"): gdata.List([q("name")], [])
            })
            testing.assertEqual(out2, exp2)
            t.success()

        t1.lock("1", None, cont2)

    t1.lock("1", None, cont1)


########################

actor overlapping_commit(t: testing.AsyncT):
    container = ttt.Container({
        q('left'): ttt.Transform(ttt.PassThrough),
        q('right'): ttt.Transform(ttt.PassThrough)
    }) ([], None)
    t1 = container.newtrans()
    t2 = container.newtrans()

    t1.configure("1", {'srcA': tree1}, None)
    t2.configure("2", {'srcB': tree2}, None)

    def cont1(_r: value):
        t2.lock("2", None, cont2)
        t1.commit("1", True)

    def cont2(_r: value):
        r1 = t1.get()
        testing.assertEqual(r1, tree1)
        t2.commit("2", True)
        r2 = t2.get()
        testing.assertEqual(r2, merge_1_2)
        r1 = t1.get()
        testing.assertEqual(r1, r2)
        t.success()

    t1.lock("1", None, cont1)


########################

actor overlapping_commit2(t: testing.AsyncT):
    container = ttt.Container({
        q('left'): ttt.Transform(ttt.PassThrough),
        q('right'): ttt.Transform(ttt.PassThrough)
    }) ([], None)
    t1 = container.newtrans()
    t2 = container.newtrans()

    t1.configure("1", {'srcA': tree1}, None)
    t2.configure("2", {'srcB': tree2}, None)

    def cont2(_r: value):
        t2.commit("2", True)
        t1.lock("1", None, cont1)

    def cont1(_r: value):
        r2 = t2.get()
        testing.assertEqual(r2, tree2)
        t1.commit("1", True)
        r1 = t1.get()
        testing.assertEqual(r1, merge_1_2)
        r2 = t2.get()
        testing.assertEqual(r1, r2)
        t.success()

    t2.lock("2", None, cont2)


########################

actor modified_commit(t: testing.AsyncT):
    container = ttt.Container({
        q('left'): ttt.Transform(ttt.PassThrough),
        q('right'): ttt.Transform(ttt.PassThrough)
    }) ([], None)
    t1 = container.newtrans()

    t1.configure("1", {'srcA': tree1}, None)
    t1.configure("1", {'srcA': tree2}, None)

    def cont1(_r: value):
        t1.commit("1", True)
        r1 = t1.get()
        testing.assertEqual(r1, tree2)
        t.success()

    t1.lock("1", None, cont1)


########################

actor modified_commit2(t: testing.AsyncT):
    container = ttt.Container({
        q('left'): ttt.Transform(ttt.PassThrough),
        q('right'): ttt.Transform(ttt.PassThrough)
    }) ([], None)
    t1 = container.newtrans()

    t1.configure("1", {'srcA': tree1}, None)

    def cont1(_r: value):
        t1.configure("1", {'srcA': tree2}, None)
        t1.commit("1", True)
        r1 = t1.get()
        testing.assertEqual(r1, tree2)
        t.success()

    t1.lock("1", None, cont1)


########################

tree0 = gdata.Container({
    q('left'): gdata.Container({
        q("l1"): gdata.List([q("name")], [
            gdata.Container({
                q("name"): gdata.Leaf("k4"),
                q("n4"): gdata.Leaf(0)
            })
        ]),
    }),
    q('right'): gdata.Container({
        q("a"): gdata.LeafList([gdata.LeafListEntryMerge(1), gdata.LeafListEntryMerge(2) ,gdata.LeafListEntryMerge(3)])
    })
})

actor modified_overlapping_commit(t: testing.AsyncT):
    container = ttt.Container({
        q('left'): ttt.Transform(ttt.PassThrough),
        q('right'): ttt.Transform(ttt.PassThrough)
    }) ([], None)
    t1 = container.newtrans()
    t2 = container.newtrans()

    t1.configure("1", {'srcA': tree0}, None)
    t2.configure("2", {'srcB': tree2}, None)

    def cont1(_r: value):
        t2.lock("2", None, cont2)
        t1.configure("1", {'srcA': tree1}, None)
        t1.commit("1", True)

    def cont2(_r: value):
        t2.commit("2", True)
        r2 = t2.get()
        testing.assertEqual(r2, merge_1_2)
        t.success()

    t1.lock("1", None, cont1)


########################

a0 = gdata.Container({
    q('left'): gdata.Container({
        q('a'): gdata.Leaf(0)
    }),
    q('right'): gdata.Container({
        q('x'): gdata.Leaf(0)
    })
})

a1 = gdata.Container({
    q('left'): gdata.Container({
        q('a'): gdata.Leaf(1)
    })
})

b1 = gdata.Container({
    q('left'): gdata.Container({
        q('b'): gdata.Leaf(1)
    })
})

a0b1 = gdata.Container({
    q('left'): gdata.Container({
        q('a'): gdata.Leaf(0),
        q('b'): gdata.Leaf(1)
    }),
    q('right'): gdata.Container({
        q('x'): gdata.Leaf(0)
    })
})

actor config_failure(t: testing.AsyncT):
    container = ttt.Container({
        q('left'): ttt.Transform(ttt.PassThrough),
        q('right'): ttt.Transform(ttt.PassThrough)
    }) ([], None)
    t1 = container.newtrans()
    t2 = container.newtrans()

    await async t1.configure("1", {'srcA': a0}, None)
    await async t2.configure("2", {'srcB': a1}, None)

    def cont1(_r: value):
        t1.commit("1", True)

        def cont2(_r: value):
            if isinstance(_r, Exception):
                t2.configure("2", {'srcB': b1}, None)
            t2.commit("2", True)
            r = t2.get()
            if r != a0b1:
                testing.assertEqual(r.prsrc(), a0b1.prsrc())
            t.success()

        t2.lock("2", None, cont2)

    t1.lock("1", None, cont1)


########################

actor config_abort(t: testing.AsyncT):
    container = ttt.Container({
        q('left'): ttt.Transform(ttt.PassThrough),
        q('right'): ttt.Transform(ttt.PassThrough)
    }) ([], None)
    t1 = container.newtrans()
    t2 = container.newtrans()

    t1.configure("1", {'srcA': a0}, None)
    t2.configure("2", {'srcB': a1}, None)

    def cont2(_r: value):
        t1.lock("1", None, cont1)
        t2.commit("2", False)

    def cont1(_r: value):
        t1.commit("1", True)
        r = t1.get()
        testing.assertEqual(r, a0)
        t.success()

    t2.lock("2", None, cont2)


########################

actor multi_lock(t: testing.AsyncT):
    container = ttt.Container({
        q('left'): ttt.Transform(ttt.PassThrough),
        q('right'): ttt.Transform(ttt.PassThrough)
    }) ([], None)
    t1 = container.newtrans()

    t1.configure("1", {'srcA': tree1}, None)

    def cont1(_r: value):

        def cont2(_r: value):
            t1.configure("1", {'srcA': tree2}, None)
            t1.commit("1", True)
            r = t1.get()
            testing.assertEqual(r, tree2)
            t.success()

        t1.lock("1", None, cont2)

    t1.lock("1", None, cont1)


########################

tree3 = gdata.Container({
    q('left'): gdata.Container({
        q("l1"): gdata.List([q("name")], []),
    }),
    q('right'): gdata.Container({
        q("b"): gdata.Leaf(0)
    })
})

actor empty_lock(t: testing.AsyncT):
    container = ttt.Container({
        q('left'): ttt.Transform(ttt.PassThrough),
        q('right'): ttt.Transform(ttt.PassThrough)
    }) ([], None)
    t1 = container.newtrans()
    t2 = container.newtrans()

    t2.configure("2", {'srcB': tree3}, None)

    def cont1(_r: value):
        t1.commit("1", True)
        t2.lock("2", None, cont2)

    def cont2(_r: value):
        t2.configure("2", {'srcB': tree2}, None)
        t2.commit("2", True)
        r = t2.get()
        testing.assertEqual(r, tree2)
        t.success()

    t1.lock("1", None, cont1)


########################

actor empty_lock2(t: testing.AsyncT):
    container = ttt.Container({
        q('left'): ttt.Transform(ttt.PassThrough),
        q('right'): ttt.Transform(ttt.PassThrough)
    }) ([], None)
    t1 = container.newtrans()
    t2 = container.newtrans()

    t2.configure("2", {'srcB': tree3}, None)

    def cont1(_r: value):
        t1.commit("1", True)    # Note: MAY happen before t2.commit!
        r2 = t2.get()
        testing.assertEqual(r2, tree2)
        r1 = t1.get()
        testing.assertEqual(r1, tree2)
        t.success()

    def cont2(_r: value):
        t2.configure("2", {'srcB': tree2}, None)
        t2.commit("2", True)
        t1.lock("1", None, cont1)

    t2.lock("2", None, cont2)


########################

actor no_lock(t: testing.AsyncT):
    container = ttt.Container({
        q('left'): ttt.Transform(ttt.PassThrough),
        q('right'): ttt.Transform(ttt.PassThrough)
    }) ([], None)
    t1 = container.newtrans()
    t2 = container.newtrans()

    t1.configure("1", {'srcA': tree1}, None)
    t2.configure("2", {'srcB': tree3}, None)

    def cont2(_r: value):
        t1.commit("1", True)
        t2.configure("2", {'srcB': tree2}, None)
        t2.commit("2", True)
        r = t2.get()
        testing.assertEqual(r, tree2)
        t.success()

    t2.lock("2", None, cont2)


########################

actor spurious_commit(t: testing.AsyncT):
    container = ttt.Container({
        q('left'): ttt.Transform(ttt.PassThrough),
        q('right'): ttt.Transform(ttt.PassThrough)
    }) ([], None)
    t1 = container.newtrans()
    t2 = container.newtrans()

    t1.configure("1", {'srcA': tree1}, None)

    def cont1(_r: value):
        t2.commit("2", True)

        t1.commit("1", True)
        r = t1.get()
        testing.assertEqual(r, tree1)
        t.success()

    t1.lock("1", None, cont1)


########################

actor spurious_config(t: testing.AsyncT):
    container = ttt.Container({
        q('left'): ttt.Transform(ttt.PassThrough),
        q('right'): ttt.Transform(ttt.PassThrough)
    }) ([], None)
    t1 = container.newtrans()
    t2 = container.newtrans()

    t1.configure("1", {'srcA': tree1}, None)
    t2.configure("2", {'srcB': tree2}, None)

    def cont1(_r: value):
        t2.configure("2", {'srcB': tree3}, None)
        t2.commit("2", True)

        t1.commit("1", True)
        r = t1.get()
        testing.assertEqual(r, tree1)
        t.success()

    t1.lock("1", None, cont1)


########################
